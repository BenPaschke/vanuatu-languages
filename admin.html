<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanuatu Languages Admin</title>
    <style>
        :root {
            --primary: #009688;
            --secondary: #2c3e50;
            --bg: #f4f4f9;
            --surface: #ffffff;
            --border: #ddd;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--secondary);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--surface);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 1.5rem; }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-danger { background-color: #dc3545; }
        .btn-secondary { background-color: #6c757d; }
        .btn-success { background-color: #28a745; }
        
        .container {
            display: flex;
            flex: 1;
            gap: 20px;
            overflow: hidden; 
        }
        
        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--surface);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-box { padding: 10px; border-bottom: 1px solid var(--border); }
        .search-box input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid var(--border); border-radius: 4px; }
        
        .lang-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .lang-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
        }
        .lang-item:hover { background-color: #f0f0f0; }
        .lang-item.active { background-color: #e0f2f1; border-left: 4px solid var(--primary); }
        .drag-handle { cursor: move; color: #999; font-size: 1.2rem; }
        
        /* Editor */
        .editor {
            flex: 1;
            background: var(--surface);
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .editor.visible { display: block; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid var(--border); border-radius: 4px; }
        
        /* Resources */
        .resource-card {
            background: #f8f9fa;
            border: 1px solid var(--border);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            position: relative;
            padding-left: 40px; /* space for drag handle */
        }
        .res-drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: move;
            color: #999;
            font-size: 1.5rem;
        }
        .resource-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #dc3545;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.2rem;
        }

        /* Dragging Styles */
        .dragging { opacity: 0.5; background: #e0e0e0; }

        #notification {
            position: fixed; bottom: 20px; right: 20px;
            background: #333; color: white; padding: 10px 20px;
            border-radius: 4px; display: none; z-index: 1000;
        }
    </style>
</head>
<body>

<header>
    <h1>Data Editor</h1>
    <div>
        <button class="btn btn-secondary" onclick="loadData()">Reload Data</button>
        <button class="btn btn-success" onclick="downloadJSON()">Download JSON</button>
    </div>
</header>

<div class="container">
    <div class="sidebar">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search languages..." oninput="renderList()">
        </div>
        <ul class="lang-list" id="langList"></ul>
        <div style="padding: 10px;">
            <button class="btn" style="width: 100%; justify-content: center;" onclick="addNewLanguage()">+ Add New Language</button>
        </div>
    </div>

    <div class="editor" id="editorArea">
        <div style="display: flex; justify-content: space-between;">
            <h2 style="margin-top: 0;">Edit Language</h2>
            <button class="btn btn-danger" onclick="deleteCurrentLanguage()">Delete Language</button>
        </div>
        
        <form>
            <div class="form-group">
                <label>Language Name</label>
                <input type="text" class="form-control" id="f_name" oninput="saveField('language_name', this.value)">
            </div>
            <div class="form-group">
                <label>Province</label>
                <select class="form-control" id="f_province" onchange="saveField('province', this.value)">
                    <option value="NATIONAL">NATIONAL</option>
                    <option value="TORBA">TORBA</option>
                    <option value="SANMA">SANMA</option>
                    <option value="PENAMA">PENAMA</option>
                    <option value="MALAMPA">MALAMPA</option>
                    <option value="SHEFA">SHEFA</option>
                    <option value="TAFEA">TAFEA</option>
                </select>
            </div>
            <div class="form-group">
                <label>Language Code</label>
                <input type="text" class="form-control" id="f_code" oninput="saveField('language_code', this.value)">
            </div>
            <div class="form-group">
                <label>Other Names (comma separated)</label>
                <textarea class="form-control" id="f_other" oninput="saveOtherNames(this.value)"></textarea>
            </div>

            <div style="margin-top: 30px; border-top: 2px solid var(--border); padding-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">Resources</h3>
                    <button type="button" class="btn btn-secondary" onclick="addResource()">+ Add Resource</button>
                </div>
                <div id="resourceList"></div>
            </div>
        </form>
    </div>
</div>

<div id="notification"></div>

<script>
    let languages = [];
    let currentIndex = -1;
    let dragSrcEl = null;

    // --- Data Loading ---
    async function loadData() {
        try {
            const response = await fetch('vanuatu_languages.json');
            languages = await response.json();
            renderList();
            showNotification('Data loaded');
        } catch (e) {
            console.error(e);
            showNotification('Error loading data', true);
        }
    }

    function downloadJSON() {
        const dataStr = JSON.stringify(languages, null, 4);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "vanuatu_languages.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // --- Rendering ---
    function renderList() {
        const list = document.getElementById('langList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        list.innerHTML = '';

        languages.forEach((lang, index) => {
            const match = (lang.language_name||'').toLowerCase().includes(search) || 
                          (lang.province||'').toLowerCase().includes(search);
            if (!match) return;

            const li = document.createElement('li');
            li.className = `lang-item ${index === currentIndex ? 'active' : ''}`;
            li.draggable = true; // Enable Drag
            li.dataset.index = index;
            
            li.innerHTML = `
                <span class="drag-handle">â˜°</span>
                <div>
                    <span style="font-weight:bold; display:block;">${lang.language_name}</span>
                    <span style="font-size:0.8rem; color:#666;">${lang.province}</span>
                </div>
            `;
            
            // Click to select
            li.onclick = (e) => {
                // Don't select if clicking drag handle
                if(e.target.classList.contains('drag-handle')) return;
                selectLanguage(index);
            };

            // Drag Events
            li.addEventListener('dragstart', handleDragStart);
            li.addEventListener('dragover', handleDragOver);
            li.addEventListener('drop', handleDropLanguage);
            li.addEventListener('dragend', handleDragEnd);

            list.appendChild(li);
        });
    }

    function selectLanguage(index) {
        currentIndex = index;
        renderList(); 
        document.getElementById('editorArea').classList.add('visible');
        
        const lang = languages[index];
        document.getElementById('f_name').value = lang.language_name || '';
        document.getElementById('f_province').value = lang.province || 'NATIONAL';
        document.getElementById('f_code').value = lang.language_code || '';
        document.getElementById('f_other').value = (lang.other_names || []).join(', ');
        
        renderResources();
    }

    function renderResources() {
        const container = document.getElementById('resourceList');
        container.innerHTML = '';
        const resList = languages[currentIndex].resources || [];

        resList.forEach((res, i) => {
            const div = document.createElement('div');
            div.className = 'resource-card';
            div.draggable = true;
            div.dataset.index = i;

            div.innerHTML = `
                <div class="res-drag-handle">â˜°</div>
                <button type="button" class="resource-remove" onclick="removeResource(${i})">&times;</button>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" class="form-control" value="${res.title}" oninput="updateResource(${i}, 'title', this.value)">
                </div>
                <div class="form-group">
                    <label>URL</label>
                    <input type="text" class="form-control" value="${res.url}" oninput="updateResource(${i}, 'url', this.value)">
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select class="form-control" onchange="updateResource(${i}, 'type', this.value)">
                        <option value="external_link" ${res.type === 'external_link' ? 'selected' : ''}>External Link ðŸ”—</option>
                        <option value="audio" ${res.type === 'audio' ? 'selected' : ''}>Audio ðŸŽ§</option>
                        <option value="video" ${res.type === 'video' ? 'selected' : ''}>Video ðŸŽ¬</option>
                        <option value="pdf" ${res.type === 'pdf' ? 'selected' : ''}>PDF ðŸ“„</option>
                        <option value="bible_app" ${res.type === 'bible_app' ? 'selected' : ''}>Bible App ðŸ“±</option>
                    </select>
                </div>
            `;

            div.addEventListener('dragstart', handleResDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDropResource);
            div.addEventListener('dragend', handleDragEnd);

            container.appendChild(div);
        });
    }

    // --- Updates ---
    function saveField(field, val) {
        if(currentIndex === -1) return;
        languages[currentIndex][field] = val;
        if(field === 'language_name' || field === 'province') renderList();
    }
    function saveOtherNames(val) {
        if(currentIndex === -1) return;
        languages[currentIndex].other_names = val.split(',').map(s=>s.trim()).filter(s=>s);
    }
    function updateResource(i, field, val) {
        languages[currentIndex].resources[i][field] = val;
    }
    function addResource() {
        if(!languages[currentIndex].resources) languages[currentIndex].resources = [];
        languages[currentIndex].resources.push({title: 'New Resource', url: '', type: 'external_link'});
        renderResources();
    }
    function removeResource(i) {
        languages[currentIndex].resources.splice(i, 1);
        renderResources();
    }
    function deleteCurrentLanguage() {
        if(confirm('Delete this language?')) {
            languages.splice(currentIndex, 1);
            currentIndex = -1;
            document.getElementById('editorArea').classList.remove('visible');
            renderList();
        }
    }
    function addNewLanguage() {
        languages.unshift({language_name: "New Language", province: "NATIONAL", resources: []});
        selectLanguage(0);
    }

    // --- Drag and Drop Logic ---
    function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        this.classList.add('dragging');
    }
    
    function handleResDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        this.classList.add('dragging');
        e.stopPropagation(); // Prevent bubbling to language item
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        return false;
    }

    function handleDropLanguage(e) {
        e.stopPropagation();
        if (dragSrcEl !== this && dragSrcEl.classList.contains('lang-item')) {
            const oldIdx = parseInt(dragSrcEl.dataset.index);
            const newIdx = parseInt(this.dataset.index);
            
            // Move item
            const item = languages.splice(oldIdx, 1)[0];
            languages.splice(newIdx, 0, item);
            
            // Update selection index if needed
            if(currentIndex === oldIdx) currentIndex = newIdx;
            
            renderList();
        }
    }

    function handleDropResource(e) {
        e.stopPropagation();
        if (dragSrcEl !== this && dragSrcEl.classList.contains('resource-card')) {
            const oldIdx = parseInt(dragSrcEl.dataset.index);
            const newIdx = parseInt(this.dataset.index);
            
            const resList = languages[currentIndex].resources;
            const item = resList.splice(oldIdx, 1)[0];
            resList.splice(newIdx, 0, item);
            
            renderResources();
        }
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
    }

    function showNotification(msg, isError) {
        const n = document.getElementById('notification');
        n.textContent = msg;
        n.style.background = isError ? '#dc3545' : '#333';
        n.style.display = 'block';
        setTimeout(() => n.style.display = 'none', 2000);
    }

    loadData();
</script>

</body>
</html>